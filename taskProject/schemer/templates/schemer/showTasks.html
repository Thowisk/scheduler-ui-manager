{% extends 'schemer/base.html' %}

{% block tasks %}

	<table class="table">
		<thead>
			<tr>
                <th scope="col">Executable File</th>
				<th scope="col">Time</th>
				<th scope="col">Date</th>
				<th scope="col">Label</th>
				<th scope="col">Cyclic on</th>
				<th scope="col">State</th>
                <th scope="col">ID</th>
				<th scope="col">Edit</th>
			</tr>
		</thead>
			<tbody>
				{% for task in tasks %}
					<tr>
						<th class="file" scope="row">{{ task.file }}</th>
                        <td>{{ task.time }}</td>
						<td>{{ task.date }}</td>
						<td>{{ task.label }}</td>
						<td>{{ task.cyclic_on }}</td>
						<td>{{ task.state }}</td>
						<td>{{ task.pk }}</td>

						<td> 
							<button 
							type="button" 
							class="btn btn-primary" 
							data-toggle="modal" 
							data-target="#editTaskModal"
							onclick="setModalData({
                                        file: '{{ task.file }}',
										time: '{{ task.time }}',
										date: '{{ task.date }}',
										label: '{{ task.label }}',
										cyclic_on: '{{ task.cyclic_on }}',
                                        interval: {{ task.interval }},
										pk: {{ task.pk }},
                                        dependency: '{{ task.dependency }}',
                                        pks: [{% for task in tasks %} '{{ task.pk }}', {% endfor %}]
										})">Edit</button> 
						</td>
					</tr>
				{% endfor %}
			<tr>
				<th scope="row"></th>
                <td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>

				<td> 
					<button 
					type="button" 
					class="btn btn-success"
					data-toggle="modal" 
					data-target="#editTaskModal"
					onclick="setModalData({
								pk: -1,
								pks: [{% for task in tasks %} '{{ task.pk }}', {% endfor %}]
								})">New task</button>
				</td>
			</tr>
		</tbody>
	</table>
	
	<div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Edit task</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form method="POST" class="form-group">{% csrf_token %}
					<div class="modal-body">
                        <label for="child"> Child task ? </label>
                        <input type="checkbox" id="child" onclick="alterForm()">
						{{ form.as_p }}		
					</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							<button type="submit" value="remove" id="removeButton" class="btn btn-danger" onclick="setRemoveInfo(); return confirm('Are you sure you wish to delete?');">Remove</button>
							<button type="submit" value="save" id="saveButton" class="save btn btn-primary" >Save</button>
							<button type="submit" value="create" id="createButton" class="btn btn-primary" onclick="prepareSend()">Create</button>
					  </div>
				</form>
			</div>
		</div>
	</div>
	
	<script>

    function setDependencyOptions(PKs, ownPK) {

    }

    function prepareSend() {
        document.getElementById('id_date').disabled = false
        document.getElementById('id_time').disabled = false
        document.getElementById('id_label').disabled = false
        document.getElementById('id_cyclic_on').disabled = false
        document.getElementById('id_interval').disabled = false
        document.getElementById('id_dependency').disabled = false
        console.log(document.getElementById('id_date').value)
        console.log(document.getElementById('id_time').value)
    }

        function alterForm(info) {
            if (info === void 0) {
                checkboxValue = document.getElementById('child').checked
                document.getElementById('id_date').disabled = checkboxValue
                document.getElementById('id_time').disabled = checkboxValue
				document.getElementById('id_label').disabled = checkboxValue
				document.getElementById('id_cyclic_on').disabled = checkboxValue
				document.getElementById('id_interval').disabled = checkboxValue
                document.getElementById('id_dependency').disabled = !checkboxValue
            } else {

            }
        }

		/*
		if info.pk < 0 then :
			launch modal as a create task modal
			clear modal fields
		else 
			launch modal an edit task modal
			fill modal fields with info			
		*/
		function setModalData(info) {
		    setDependencyOptions(info.pks, info.pk)
			document.getElementById('id_option').style.display = 'none';
			document.querySelector("label[for=id_option]").style.display = 'none';
			try {
				document.querySelector(".errorlist").style.display = 'none';
			} catch (e) {}
			if (info.pk < 0) {
			    //create section
				document.getElementById('saveButton').style.display = 'none';
				document.getElementById('removeButton').style.display = 'none';
				document.getElementById('createButton').style.display = 'block';
				document.getElementById('id_file').style = ''
				document.getElementById('id_date').value = getCurrentDate()
                document.getElementById('id_time').value = getCurrentTime()
				document.getElementById('id_label').value = '';
				document.getElementById('id_cyclic_on').value = '';
				document.getElementById('id_interval').value = 1
				document.getElementById('id_option').value = 0;
				document.getElementById('child').checked = false

                //console.log(currentDate)
                //console.log(currentYear_Month_Day)
                //console.log(currentTime)

			} else {
			    // edit section
			    try {
			        document.getElementById('saveButton').style.display = 'block';
				    document.getElementById('removeButton').style.display = 'block';
				    document.getElementById('createButton').style.display = 'none';
				    document.getElementById('id_file').value = info.file;
				    document.getElementById('id_date').value = formatDate(info.date);
				    document.getElementById('id_time').value = formatTime(info.time);
				    document.getElementById('id_label').value = info.label;
				    document.getElementById('id_cyclic_on').value = info.cyclic_on;
				    document.getElementById('id_interval').value = info.interval;
				    document.getElementById('id_option').value = info.pk;
				    document.getElementById('child').checked = info.dependency === None
                } catch (e) { }


			}
			// console.log(info);
            alterForm(info)

            {#console.log('save button : ')#}
            {#console.log(document.getElementById('saveButton').style.display)#}
            {##}
            {#console.log('create button : ')#}
            {#console.log(document.getElementById('createButton').style.display)#}
            {##}
            {#console.log('remove button : ')#}
            {#console.log(document.getElementById('removeButton').style.display)#}

		}
		function setRemoveInfo() {
			document.getElementById('id_option').value = -1 * document.getElementById('id_option').value;
		}
		

		function getCurrentDate() {
		    const currentDate = new Date();
		    let monthAdjuster = '';
            let dayAdjuster = '';
            if (currentDate.getMonth()+1<10) {
                monthAdjuster = '0'
            }
            if(currentDate.getDate()<10) {
                dayAdjuster = '0'
            }

            date = '' + currentDate.getFullYear()
                    + '-'
                    + monthAdjuster
                    + (currentDate.getMonth()+1)
                    + '-'
                    + dayAdjuster
                    + currentDate.getDate();
            return date
        }

        function getCurrentTime() {
		    return new Date()
                    .toString()
                    .split(' ')[4]
                    .slice(0, -3);
        }

		function formatDate(date) {
			const dateParts = date.split(' ');
			const months = {
			    'January': '01',
                'February': '02',
                'March': '03',
                'April': '04',
                'May': '05',
                'June': '06',
                'July': '07',
                'August': '08',
                'September': '09',
                'October': '10',
                'November': '11',
                'December': '12'
			};
			let d = dateParts[1].replace(',', '');
			if (d.length < 2) {
				d = '0' + d;
			}
			let m = months[dateParts[0]];
			let y = dateParts[2];
			return y + '-' + m + '-' + d;
		}
		
		function formatTime(time) {
			const timeParts = time.split(' ');
			const h_m = timeParts[0].split(':');
			if (timeParts[1] === 'p.m.' && h_m[0] !== '12') {
				h_m[0] = ''+(parseInt(h_m[0])+12);
			} else if (timeParts[1] === 'a.m.' && h_m[0] === '12') {
				h_m[0] = ''+(parseInt(h_m[0])-12);
			}
			if (h_m[0].length < 2) {
				h_m[0] = '0' + h_m[0];
			}
			return h_m[0] + ':' + h_m[1];
		}

		function formatFiles() {
            let files = document.getElementsByClassName('file')
            for(let file of files) {
                file.innerHTML = file.innerHTML.split('/').splice(-1)[0]
            }
        }

		if (window.history.replaceState) {
			window.history.replaceState(null, null, window.location.href);
		}
	</script>

{% endblock %}